version: 1
frontend:
  phases:
    preBuild:
      commands:
        - REPO_ROOT="$CODEBUILD_SRC_DIR/nonaga"
        # Clean install dependencies for online frontend (fix rollup native module issue)
        - cd "$REPO_ROOT/online" && rm -rf node_modules package-lock.json && npm install
    build:
      commands:
        - REPO_ROOT="$CODEBUILD_SRC_DIR/nonaga"
        # Build online frontend
        - cd "$REPO_ROOT/online" && npm run build
        # Debug: verify build output exists
        - ls -la "$REPO_ROOT/online/dist"
        # Stage built files to ensure copy succeeds before cleanup
        - rm -rf "$REPO_ROOT/online-build" && mkdir -p "$REPO_ROOT/online-build"
        - cp -R "$REPO_ROOT/online/dist/." "$REPO_ROOT/online-build/"
        # Replace source files with built files
        - rm -rf "$REPO_ROOT/online/src" "$REPO_ROOT/online/node_modules" "$REPO_ROOT/online/package.json" "$REPO_ROOT/online/package-lock.json" "$REPO_ROOT/online/tsconfig.json" "$REPO_ROOT/online/tsconfig.node.json" "$REPO_ROOT/online/vite.config.ts" "$REPO_ROOT/online/.env" "$REPO_ROOT/online/dist"
        - cp -R "$REPO_ROOT/online-build/." "$REPO_ROOT/online/"
        - rm -rf "$REPO_ROOT/online-build"
        # Fail build if dev HTML is still present
        - if grep -n "/src/main.tsx" "$REPO_ROOT/online/index.html"; then echo "ERROR online index is dev HTML"; exit 1; fi
        # Debug: show final structure
        - ls -la "$REPO_ROOT/online/"
  artifacts:
    baseDirectory: .
    files:
      # Include existing static files
      - index.html
      - app.jsx
      - app.css
      - public/**/*
      - about/**/*
      - en/**/*
      - sitemap.xml
      - robots.txt
      # Include built online frontend (now directly in online/)
      - online/**/*
  customHeaders:
    - pattern: '**/*'
      headers:
        - key: Cache-Control
          value: 'public, max-age=31536000, immutable'
    - pattern: '*.html'
      headers:
        - key: Cache-Control
          value: 'public, max-age=0, must-revalidate'
  rewrites:
    # SPA fallback for /online/* routes
    - source: /online/<*>
      target: /online/index.html
      status: '200'
